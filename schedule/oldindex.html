<html>
<head>
	<meta charset="utf-8">
	<title>GSW Schedule of Classes:  Fall Semester 2015</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.0.js"></script>
	<script>
		function updateInstructorInfo(tr,name,lname,keyName) {
			var td = tr.find("td:eq(12)");
			td.attr('title',localStorage.getItem(keyName));
			if(localStorage.getItem(keyName).indexOf('No results were found') !== 0) {
				td
				.empty()
				.append(
					$('<a>')
					.attr('href','https://gsw.edu/searchDirectory/employee/search.php?name=' + lname)
					.attr('target','_blank')
					.text(name)
				);
			}
		};
		$(window).load(function(){
			var term = "201508";
			var cnt = 0;
			$("body").load("raintaker.php?schedterm=" + term,function(){
				$("img").each(function(){
					var temp = $(this).attr('src');
					$(this).attr('src', 'https://rain.gsw.edu/' + temp);
				});
				$('title').after($("<a href='#'>").css('float','right').click(function(){localStorage.clear();location.reload();return false;}).text('Refresh data'));
				$("font > table").each(function(table_index){
					if(table_index < 0) {
						return true;
					}
					$(this).find("tr:gt(0)").each(function(tr_index){
						var subj = $(this).find("td:eq(2)").text().trim();
						//-- Store refernce to table row
						var tr = $(this);
						//-- Retrieve course information and replace course 'title' by a link to RAIN
						var numb = tr.find("td:eq(3)").text().trim();
						var desc = tr.find("td:eq(4)").text().trim();
						if(subj !== "" && subj.length >= 3) {
							var anchor = subj + '_' + numb;
							if(tr_index >= 0) {
								tr.find("td:eq(4)").empty().append($("<a>").attr({'href':'#'+anchor,'name':anchor}).text(desc).click(function(){
									if(tr.next().find('td').length == 1) {
										tr.next().toggle('fast');
									}
									else {
										tr.after($("<tr>").append($("<td colspan='14' style='border: 1px solid black;'>")));
										var container = tr.next().find('td');
										var keyDesc = "sched.desc(" + anchor + ")";
										if(localStorage.getItem(keyDesc) === null) {
											$.get("raintaker.php?term=" + term + "&subj=" + subj + "&numb=" + numb, function(data){
												localStorage.setItem(
													keyDesc,$(data).find("table.datadisplaytable tr td.ntdefault").each(function(){
														$(this).find('a').each(function(){
															$(this).attr('href', this.href.replace(document.domain,'rain.gsw.edu'))
														})
													}).html()
												);
												container.append(localStorage.getItem(keyDesc));
											});
										}
										else {
											container.append(localStorage.getItem(keyDesc));
										}
									}
									return false;
								}));
							}
							else {
								//-- old solution to add links to course names -- not in use now, kept here for reference
								tr.find("td:eq(4)").empty().append($('<a>').attr({'href':'#'}).text(desc).click(function(){
									window.location.assign(
										"https://rain.gsw.edu/prod8x/bwckctlg.p_disp_course_detail" +
										"?cat_term_in=" + term +
										"&subj_code_in=" + subj +
										"&crse_numb_in=" + numb
									);
								}));
							}
						}
						//-- Retrieve instructor's name and add contact info as a tooltip
						var name = tr.find("td:eq(12)").text().trim();
						var keyName = "sched.name(" + name + ")";
						var lname = name;
						var fname = '';
						if(name.split(',').length > 1) {
							lname = name.split(",")[0].trim();
							fname = name.split(",")[1].trim();
						}
						if(localStorage.getItem(keyName) === null) {
							$.ajax(
								"raintaker.php",
								{
									method: "GET",
									data : "name=" + lname,
									async : true,
									success : function(data){
										var blocks = $($(data)[7]).find("p");
										if(blocks.length == 1) {
											localStorage.setItem(keyName, blocks.text());
										}
										else {
											var initialsNotFound = true;
											blocks.each(function(p_index){
												var fullname = $(this).find('b:eq(0)').text().trim();
												var email = $(this).find('a:eq(0)').text().trim();
												var nameparts = fullname.split(" ",4);
												for(var i=0, tot=nameparts.length-1; i<tot; i++) {
													if(nameparts[i].indexOf(fname.substring(0,1)) === 0) {
														localStorage.setItem(keyName, $(this).text());
														initialsNotFound = false;
														return false;
													}
												}
												if(initialsNotFound === true && email.split('@')[1] === 'gsw.edu' && email.indexOf(fname.substring(0,1).toLowerCase()) === 0) {
													localStorage.setItem(keyName, $(this).text());
													initialsNotFound = false;
													return false;
												}
											});
											if(initialsNotFound === true) {
												localStorage.setItem(keyName, blocks.first().text());
											}
										}
										updateInstructorInfo(tr,name,lname,keyName);
									}
								}
							);
						}
						else {
							updateInstructorInfo(tr,name,lname,keyName);
							//console.log(keyName + ' found in localStorage');
						}
					});
				});
			});
		})
	</script>
</head>
</html>
